# Configure Salesforce REST API access

In Salesforce, you can use OAuth authorization to approve a client application's access to your org's protected resources. It is required if you want to perform Salesforce REST API calls to create, update, or query records in any of your contact flows. There are three steps to setup OAuth access for your AWS Lambda function:

1.  Set Up OAuth in Your Service Cloud Voice Connected App
1.  Update the configuration in AWS
1.  Validate the function

## Set Up OAuth in your Service Cloud Voice connected app
> **_IMPORTANT:_** You will need a private key and self-signed digital certificate for this process. Please follow the [steps provided by Salesforce to create these](https://developer.salesforce.com/docs/atlas.en-us.238.0.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_key_and_cert.htm).

These instructions describe how to set up OAuth in the Salesforce-created connected app.
1.  From Setup, enter `Apps` in the **Quick Find** box, and select **App Manager**.
1.  Find the app named **{Your Contact Center Name} Connect App for RestAPI OAuth**.
1.  Select **Edit** in the dropdown menu.
1.  Verify that **Enable OAuth Settings** is selected.
1.  Verify that the **Callback URL** is: `http://localhost:1717/OauthRedirect`.
1.  Select Use digital signatures
1.  Select **Choose file** and upload the self-signed certificate file (ends in .crt) that you created earlier.
1.  For the Selected OAuth Scopes, ensure that the following scopes are selected.
    *  Manage user data via APIs (api)
    *  Perform requests at any time (refresh_token, offline_acess)
1.  Save your settings. ![Edited Connected App](/static/01/connected_app_edit.png)
1.  Select **Continue**.
1.  From the saved connected app with OAuth, select **Manage Consumer Details**. A new tab will open and you will be asked to re-verify your identity.
1.  Once you have verfied your identity and the tab refreshes, copy the **Consumer Key**, which is needed on the Amazon Connect instance.
1.  Select **Manage**.
1.  Scroll down to the **Profiles** section and select **Manage Profiles**.
1.  Select the box for **System Administrator** and choose **Save**. ![Allowed profiles for the connected app.](/static/01/connected_app_profiles.png)

## Set Up OAuth in the AWS Lambda Function
These instructions describe how to set up OAuth on your Amazon Connect instance. Before you start, open a text file so you can copy some parameter values.
1.  Log in to **AWS Console** > **Lambda** > **Functions**.
1.  Select the **{Your Contact Center Name}-InvokeSalesforceRestApiFunction** Lambda function.
1.  Select **Configuration** > **Environment variables**.
1.  Note the values for **CONSUMER_KEY_PARAM_NAME**, **PRIVATE_KEY_PARAM_NAME**, and **SUBJECT**. You will need to modify these specific parameters in the Parameter Store.  ![Environment Variables](/static/01/environment_variables.png)
1.  Select **Services** > enter **SSM** in the search box > and choose **Systems Manager**.
1.  Under **Application Management**, choose **Parameter Store**. ![Parameter Store](/static/01/parameter_store.png)
1.  Select the name that matches the value you copied for **CONSUMER_KEY_PARAM_NAME**, and choose **Edit**.
1.  Clear the contents of the Value field, and replace it with the Consumer Key value you copied from your connected app in Salesforce, then select **Save changes**.
1.  Select the name that matches the value you copied for **PRIVATE_KEY_PARAM_NAME**, and choose **Edit**.
1.  Clear the contents of the Value field, and replace it with the entire contents of the **server.key** file you created earlier, then select **Save changes**.
> **_IMPORTANT:_** The private key isn’t the same as the consumer secret, although both are generated by the same key. The private key begins with “-----BEGIN RSA PRIVATE KEY-----” and ends with “-----END RSA PRIVATE KEY-----”. Be sure to include that BEGIN and END text as part of the key value.

11.  Select the name that matches the value you copied for **SUBJECT**, and choose **Edit**.
11.  Enter your main administrator username, which should be your developer account login, then select **Save changes**.

## Test OAuth with Service Cloud Voice Lambda Function
To test that you have OAuth set up for the InvokeSalesforceRestApiFunction Lambda function, create a test event.
1.  Log in to **AWS Console** > **Lambda** > **Functions**.
1.  Select the **{Your Contact Center Name}-InvokeSalesforceRestApiFunction** Lambda function.
1.  Select the **Test** dropdown menu and choose **Configure test event**.
1.  Provide an **Event name**.
1.  Copy the JSON information below and replace the existing event JSON. 
```
{
  "Details": {
    "Parameters": {
      "methodName": "queryRecord",
      "soql": "SELECT Id FROM User LIMIT 1"
    }
  }
}
```
6.  Select **Save**.
6.  Select **Test**.
6.  You should receive a response similar to:
```
{
  "Id": "0058b00000GDAKMAA5"
}
```
7. You have validated Salesforce REST API access from AWS Lambda.

> **_CONGRATULATIONS!!_** You have completed the initial creation and validation of your contact center using Service Cloud Voice with Amazon Connect.
>  You have completed all preparation work for the Service Cloud Voice bootcamp.
